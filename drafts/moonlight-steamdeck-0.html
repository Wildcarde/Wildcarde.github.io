<!DOCTYPE html>
<html lang="en">
<head>
          <title>Putting the Pieces Together</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta charset="utf-8" />
        <!-- twitter card metadata -->
<meta name="twitter:site" content="@Wildcarde815">
<meta name="twitter:title" content="Setting up Moonlight and Sunshine to Stream to Steamdeck">
<meta name="twitter:description" content="">
        <!-- OG Tags -->
<meta property="og:url" content="https://blog.shadowgears.com/drafts/moonlight-steamdeck-0.html"/>
<meta property="og:title" content="Putting the Pieces Together | Setting up Moonlight and Sunshine to Stream to Steamdeck" />
<meta property="og:description" content="" />
        <!-- favicon -->
        <!-- moment.js for date formatting -->
        <script src="https://blog.shadowgears.com/theme/js/moment.js"></script>
        <!-- css -->
        <link rel="stylesheet" type="text/css" href="https://blog.shadowgears.com/theme/css/main.css" />
		<script>
			
                /*! grunt-grunticon Stylesheet Loader - v2.1.2 | https://github.com/filamentgroup/grunticon | (c) 2015 Scott Jehl, Filament Group, Inc. | MIT license. */
    
    (function(e){function t(t,n,r,o){"use strict";function a(){for(var e,n=0;u.length>n;n++)u[n].href&&u[n].href.indexOf(t)>-1&&(e=!0);e?i.media=r||"all":setTimeout(a)}var i=e.document.createElement("link"),l=n||e.document.getElementsByTagName("script")[0],u=e.document.styleSheets;return i.rel="stylesheet",i.href=t,i.media="only x",i.onload=o||null,l.parentNode.insertBefore(i,l),a(),i}var n=function(r,o){"use strict";if(r&&3===r.length){var a=e.navigator,i=e.Image,l=!(!document.createElementNS||!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect||!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Image","1.1")||e.opera&&-1===a.userAgent.indexOf("Chrome")||-1!==a.userAgent.indexOf("Series40")),u=new i;u.onerror=function(){n.method="png",n.href=r[2],t(r[2])},u.onload=function(){var e=1===u.width&&1===u.height,a=r[e&&l?0:e?1:2];n.method=e&&l?"svg":e?"datapng":"png",n.href=a,t(a,null,null,o)},u.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",document.documentElement.className+=" grunticon"}};n.loadCSS=t,e.grunticon=n})(this);(function(e,t){"use strict";var n=t.document,r="grunticon:",o=function(e){if(n.attachEvent?"complete"===n.readyState:"loading"!==n.readyState)e();else{var t=!1;n.addEventListener("readystatechange",function(){t||(t=!0,e())},!1)}},a=function(e){return t.document.querySelector('link[href$="'+e+'"]')},c=function(e){var t,n,o,a,c,i,u={};if(t=e.sheet,!t)return u;n=t.cssRules?t.cssRules:t.rules;for(var l=0;n.length>l;l++)o=n[l].cssText,a=r+n[l].selectorText,c=o.split(");")[0].match(/US\-ASCII\,([^"']+)/),c&&c[1]&&(i=decodeURIComponent(c[1]),u[a]=i);return u},i=function(e){var t,o,a;o="data-grunticon-embed";for(var c in e)if(a=c.slice(r.length),t=n.querySelectorAll(a+"["+o+"]"),t.length)for(var i=0;t.length>i;i++)t[i].innerHTML=e[c],t[i].style.backgroundImage="none",t[i].removeAttribute(o);return t},u=function(t){"svg"===e.method&&o(function(){i(c(a(e.href))),"function"==typeof t&&t()})};e.embedIcons=i,e.getCSS=a,e.getIcons=c,e.ready=o,e.svgLoadedCallback=u,e.embedSVG=u})(grunticon,this);
                
                grunticon(["https://blog.shadowgears.com/theme/css/icons.data.svg.css", "https://blog.shadowgears.com/theme/css/icons.data.png.css", "https://blog.shadowgears.com/theme/css/icons.fallback.css"]);
            </script>
        <noscript><link href="https://blog.shadowgears.com/theme/css/icons.fallback.css" rel="stylesheet"></noscript>
        <!-- menu toggle javascript -->
        <script type="text/javascript">
            document.addEventListener("DOMContentLoaded", initMenu);
            
            function initMenu(){
                var menu = document.getElementById("menu");
                var menulink = document.getElementById("menu-link");
                menulink.addEventListener("click", function toggleMenu(){
                        window.event.preventDefault();
                        menulink.classList.toggle('active');
                        menu.classList.toggle('active');              
                    });
            };
        </script>


    <meta name="tags" content="deployment" />
    <meta name="tags" content="blog" />

</head>
<body>
    <div role="banner" id="masthead">
        <header>
            <h1><a href="/">Garrett's Blog</a></h1>
            <a href="#menu" id="menu-link">more stuff</a>
            <nav id="menu">
                <ul>
                            <li><a href="https://blog.shadowgears.com/category/glass-canopy.html">Glass Canopy</a></li>
                            <li class="active"><a href="https://blog.shadowgears.com/category/howto.html">HowTo</a></li>
                </ul>
            </nav>
        </header>
    </div>
        <div class="page" role="main">
  <div class="article" role="article">
    <article>
        <footer>
            <a name="top"></a>
            <p>
              <time datetime=" 2023-09-14 00:00:00-04:00">
                <script>document.write(moment('2023-09-14 00:00:00-04:00').format('LL'));</script>
              </time>
            </p>
        </footer>
        <header>
          <h2>
            Setting up Moonlight and Sunshine to Stream to Steamdeck
          </h2>
        </header>
      <div class="content">
         <h1>The Problem</h1>
<p>While Steam streaming and Sunshine are both pretty straight forward to configure if you don't ask much from them, getting them to play nice with a 3 screen computer setup is a relatively poor experience.  This is doubly true if the main screen in use is an ultra-wide as these tools do not change the aspect ratio or screen behaviors when streaming out of the box. So when you have a screen setup that looks like a Tie Fighter it is a less than ideal experience between sunshine and moonlight. Lets solve that!</p>
<h1>The Goal</h1>
<p>When you initiate a connection to sunshine from moonlight on the steamdeck the system should automatically configure the windows PC. This includes disabling secondary displays and adjusting the resolution to match the steamdeck.  When the moonlight connection is terminated, roll back these changes and restore the screens to their default resolution and state.</p>
<h2>Prereqs</h2>
<p>There's a few things we are going to take for granted here to start.</p>
<ul>
<li>You (the reader) have an up to date copy of sunshine installed on your desktop of choice.</li>
<li>The basics of this are covered in the <a href="https://docs.lizardbyte.dev/projects/sunshine/en/latest/about/installation.html">sunshine docs</a>.</li>
<li>You have a copy of moonlight installed and configured as a tile on your steamdeck.</li>
<li>This is covered extensively in blog posts and YouTube videos the world over, <a href="https://pimylifeup.com/steam-deck-moonlight/">this was the first google hit for me and looks to be a solid explanation</a>.</li>
<li>A copy of NirSoft's <a href="https://www.nirsoft.net/utils/multi_monitor_tool.html">Multi-Monitor Tool</a>.</li>
<li>This should be placed somewhere you can easily locate and reliably find.  I put it inside a folder simply labeled 'programs' in my home directory.</li>
<li>A piece of software you want to make work by streaming to your steamdeck, I'll be using <a href="https://playnite.link/">Playnite</a> as it lets me aggregate all my desktop game stores into one library interface.</li>
</ul>
<h2>Details to have in front of you before you start</h2>
<ul>
<li>Full drive path to your program folder, for example: <code>C:\Users\&lt;username&gt;\Programs\</code></li>
<li>Additionally make note of where MultiMonitorTool is, ie: <code>C:\Users\&lt;username&gt;\Programs\multimonitortool-x64\</code></li>
<li>How many monitors you have, for example: <code>3</code></li>
<li>The full path to the executable you want to run, for example for Playnite: <code>C:\Users\&lt;username&gt;\AppData\Local\Playnite\Playnite.Fullscreenapp.exe</code></li>
<li>The working directory you want the program to run in, some applications don't care but Playnite does so: <code>C:\Users\&lt;username&gt;\AppData\Local\Playnite\</code></li>
</ul>
<h1>HowTo</h1>
<p>The basic gist of this is that we are going to use MultiMonitorTool to capture our default configuration, and then the configuration we want for when things are streamed out to the steam deck as configuration files.  Once these are captured we'll use a set of batch scripts to swap the two modes back and forth automatically. You could make this more robust using a proper scripting language like powershell or python but for our purposes here a brute force batch file is sufficient.</p>
<h2>Capture Monitor Configurations</h2>
<p>To get started, in the windows display settings configure your screens as you would like them to be by default. After this is set start up the MultiMonitorTool GUI and you'll see a window similar to below.</p>
<p><img alt="MultiMonitorTool All Screens Enabled" src="https://blog.shadowgears.com/drafts/2023-multimon-all.png"></p>
<p>Once everything is configured as desired, simply go to the <code>File</code> menu button and select <code>Save Monitors Configuration</code>.  Place this file somewhere easily located and named something sensible. In my case I chose to simply put this in the folder for MultiMonitorTool and name it <code>default.cfg</code> as this makes the scripts below easier.</p>
<p>After this is complete, reconfigure the screens to be setup as you would like them to be for the Steamdeck or other streaming target. For the Steamdeck, the native resolution is <code>1280x800</code>; so I've disabled the right and left screens on my system and set the primary screens resolution to <code>1280x800</code>.</p>
<p>Once this is complete, check that the changes are reflected in MultiMonitorTool's GUI (as below) and save this new configuration in the same place as the first.  I named this file simply <code>steamdeck-native.cfg</code> so it's easy to find.</p>
<p><img alt="MultiMonitorTool Steamdeck Native Config" src="https://blog.shadowgears.com/drafts/2023-multimon-single.png"></p>
<h2>Start Script</h2>
<p>This start-up script is invoked before launching the Playnite executable, you'll need to make a copy of the script below on your local machine. This can be as simply as copying this and pasting it into notepad. This script will turn off your secondary screens and force the resolution settings expected to the primary monitor by invoking the related config file.</p>
<p><em>Note:</em> You will need to update the <code>cd</code> entry to where your MultiMonitorTool executable is located.</p>
<p><code>sd-native.bat:</code></p>
<div class="highlight"><pre><span></span><code><span class="p">:</span><span class="c1">: disable secondary monitors and switch main monitor to steamdeck native resolution</span>
<span class="p">:</span><span class="c1">:</span>
<span class="p">@</span><span class="k">ECHO</span> OFF
<span class="p">:</span><span class="c1">: update working directory to location of multi monitor tool software.</span>
<span class="k">cd</span> C:\Users\<span class="p">&lt;</span>username<span class="p">&gt;</span>\Programs\multimonitortool-x64
<span class="p">:</span><span class="c1">: toggle off secondary displays; if you have more than 3 displays,</span>
<span class="p">:</span><span class="c1">: add additional display indexes below to turn off all screens except the primary.</span>
.\MultiMonitorTool.exe /disable 2 3
<span class="p">:</span><span class="c1">: load steamdeck compatible configuration file, if you used a different file name</span>
<span class="p">:</span><span class="c1">: you will need to use that config file name here.</span>
.\MultiMonitorTool.exe /LoadConfig ./steamdeck-native.cfg
<span class="p">:</span><span class="c1">: these changes tend to take a few seconds and we don&#39;t want anything to launch before hand</span>
<span class="p">:</span><span class="c1">: so just a quick pause so it doesn&#39;t launch while things are changing.</span>
timeout /t 2
</code></pre></div>


<h2>Exit Script</h2>
<p>This script is functionally the inversion of the above script and is meant to run when exiting a sunshine application. This will forcibly restore the default screen configuration but has some subtleties to be aware of. The <code>/LoadConfig</code> flag seems to have some issues with restoring several screens at once, however it can simply be run multiple times to force the system to enable all screens. As such you will need to include the line <code>.\MultiMonitorTool.exe /LoadConfig ./default.cfg</code> once for each monitor you need to re-activate.</p>
<p><em>Note:</em> As above you will need to update the <code>cd</code> command to the appropriate location for your system.</p>
<p><code>default-monitor-config.bat</code></p>
<div class="highlight"><pre><span></span><code><span class="p">:</span><span class="c1">:reset the monitor configuration to default</span>
<span class="p">:</span><span class="c1">:</span>
<span class="p">@</span><span class="k">ECHO</span> OFF
<span class="p">:</span><span class="c1">: update working directory to location of multi monitor tool software.</span>
<span class="k">cd</span> C:\Users\<span class="p">&lt;</span>username<span class="p">&gt;</span>\Programs\multimonitortool-x64
<span class="p">:</span><span class="c1">: re-assert default screen configuration</span>
.\MultiMonitorTool.exe /LoadConfig ./default.cfg
.\MultiMonitorTool.exe /LoadConfig ./default.cfg
</code></pre></div>


<h2>Putting it Together in an Application Entry</h2>
<p>To get started I would make a new application entry for this, while it's theoretically possible to make these scripts adapt to using the <code>ENVVAR</code> values supplied at the bottom of the application page that's out of scope for this discussion. Naming the new application entry something that makes it clear it's a SteamDeck config will help make things obvious on the client side.  I went with simply <code>Playnite - SD</code>.</p>
<p>In this new application entry add the full path to your <code>sd-native.bat</code> file to the first entry in the <code>Do Command</code> column. In the neighboring column under <code>Undo Command</code> place the full path to the <code>default-monitor-config.bat</code> file.</p>
<p>For Playnite specifically it's a good idea to add two additional <code>Undo Command</code> entries of <code>taskkill /f /im Playnite.DesktopApp.exe</code> and <code>taskkill /f /im Playnite.FullscreenApp.exe</code>.  Adding these ensures terminating the application entry also kills Playnite.</p>
<p>Under the <code>Command</code> entry further down the page you will need to add the path to Playnite's main executable, this is typically <code>C:\Users\&lt;username&gt;\AppData\Local\Playnite\Playnite.FullscreenApp.exe</code>, and you'll want to set the entry <code>Working Directory</code> to simply <code>C:\Users\&lt;username&gt;\AppData\Local\Playnite\</code>.</p>
<p>At this point you are done, the setup should be ready to test out and stream from.</p>
<h1>Areas Of Improvement</h1>
<ul>
<li>Currently if something goes pear shaped killing the Playnite session will not terminate the underlying application that was launched by it.</li>
<li>The script for turning off secondary monitors can fail if the systems graphics drivers have been updated but the system has not been rebooted; the most direct work around is to simply reboot after these kinds of updates.</li>
</ul>
      </div>
      <div class="back-to-top">
          <a href="#top">back to top</a>
      </div>
    </article>
  </div>
<!-- end article -->
                <footer>
                    <div class="icons">
                        <a href="https://twitter.com/Wildcarde815" target="_blank"><div class="icon-twitter icon"></div></a>
                        <a href="https://github.com/Wildcarde" target="_blank"><div class="icon-github icon"></div></a>
                    </div>
                    <p>© <script>document.write(moment().format('YYYY'));</script> Garrett McGrath</p>
 
                    <p><i>"Brutal"</i> Pelican Theme</p>
                    <p>Designed and built by <a href="http://twitter.com/mcman_s">@mcman_s</a> in Denver</p>
                </footer>
        </div>
</body>
</html>